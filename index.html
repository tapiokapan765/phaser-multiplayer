<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Phaser 2人対戦</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.js"></script>
</head>
<body>
<script>
const config = {
  type: Phaser.AUTO,
  width: 800,
  height: 600,
  backgroundColor: '#2d2d2d',
  physics: { default: 'arcade', arcade: { gravity: { y: 0 } } },
  scene: { preload, create, update }
};
const game = new Phaser.Game(config);

let player, keys, bullets, lastFired=0, aim;
let others = {};
const COOLDOWN = 500;
let scene;

const socket = new WebSocket("wss://phaser-multiplayer-p8jn.onrender.com"); // ← Render の URL に置き換え
let socketId = null;

socket.addEventListener('open', () => {
  socketId = Date.now() + Math.random();
  console.log('Connected to server');
});

socket.addEventListener('message', event => {
  const msg = JSON.parse(event.data);
  if(msg.id === socketId) return;

  const data = JSON.parse(msg.data);
  if(!others[msg.id]){
    others[msg.id] = {
      rect: scene.add.rectangle(data.x,data.y,50,50,0x00ff00),
      bullets: []
    };
  } else {
    others[msg.id].rect.x = data.x;
    others[msg.id].rect.y = data.y;
  }

  // 他プレイヤーの弾同期
  if(data.bullets){
    // 古い弾を消す
    others[msg.id].bullets.forEach(b => b.destroy());
    others[msg.id].bullets = [];
    data.bullets.forEach(bdata => {
      const b = scene.add.rectangle(bdata.x, bdata.y, 8, 8, 0x00ff00);
      scene.physics.add.existing(b);
      b.body.setVelocity(bdata.vx, bdata.vy);
      others[msg.id].bullets.push(b);
    });
  }
});

function preload() {}

function create() {
  scene = this;

  // プレイヤー
  player = this.add.rectangle(400, 500, 50, 50, 0xffffff);
  this.physics.add.existing(player);
  player.body.setCollideWorldBounds(true);

  // 弾
  bullets = this.physics.add.group();

  // 照準
  aim = this.add.rectangle(player.x, player.y-30, 4, 40, 0xff0000, 0.8);
  aim.setOrigin(0.5,1);

  // WASD
  keys = this.input.keyboard.addKeys({w:'W', a:'A', s:'S', d:'D'});
}

function update(time) {
  // 移動
  player.body.setVelocity(0);
  if(keys.a.isDown) player.body.setVelocityX(-200);
  if(keys.d.isDown) player.body.setVelocityX(200);
  if(keys.w.isDown) player.body.setVelocityY(-200);
  if(keys.s.isDown) player.body.setVelocityY(200);

  // マウス方向
  const pointer = this.input.activePointer;
  const angle = Phaser.Math.Angle.Between(player.x, player.y, pointer.x, pointer.y);
  aim.x = player.x;
  aim.y = player.y;
  aim.rotation = angle + Math.PI/2;

  // 弾発射
  if(pointer.isDown && time>lastFired){
    lastFired = time + COOLDOWN;
    const b = bullets.create(player.x, player.y, null);
    b.body.setCircle(8);
    b.body.setVelocity(Math.cos(angle)*400, Math.sin(angle)*400);
  }

  // 弾削除
  bullets.getChildren().forEach(b => {
    if(b.x<0||b.x>800||b.y<0||b.y>600) b.destroy();
  });

  // サーバーに送信
  if(socket.readyState===WebSocket.OPEN){
    // 自分の位置＋弾情報を送信
    const bulletsData = bullets.getChildren().map(b=>({x:b.x, y:b.y, vx:b.body.velocity.x, vy:b.body.velocity.y}));
    socket.send(JSON.stringify({x:player.x, y:player.y, bullets: bulletsData}));
  }
}
</script>
</body>
</html>
